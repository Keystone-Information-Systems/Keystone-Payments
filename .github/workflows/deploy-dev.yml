name: Deploy KeyPay Lambdas (dev)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and deploy (${{ matrix.function_name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - function_name: keypay-api-dev
            project: KeyPay-Backend/src/KeyPay.Api/KeyPay.Api.csproj
            publish_dir: KeyPay-Backend/publish/keypay-api-dev
            zip_path: KeyPay-Backend/publish/keypay-api-dev.zip
          - function_name: keypay-authorizer-dev
            project: KeyPay-Backend/src/KeyPay.Authorizer/KeyPay.Authorizer.csproj
            publish_dir: KeyPay-Backend/publish/keypay-authorizer-dev
            zip_path: KeyPay-Backend/publish/keypay-authorizer-dev.zip
          - function_name: keypay-webhook-dev
            project: KeyPay-Backend/src/KeyPay.Webhook/KeyPay.Webhook.csproj
            publish_dir: KeyPay-Backend/publish/keypay-webhook-dev
            zip_path: KeyPay-Backend/publish/keypay-webhook-dev.zip

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: "244706281753"
      DOTNET_NOLOGO: "true"
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore KeyPay-Backend/KeyPay.sln

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-oidc-keypay-dev
          aws-region: ${{ env.AWS_REGION }}

      - name: Publish (${{ matrix.function_name }})
        run: |
          dotnet publish "${{ matrix.project }}" \
            -c Release \
            -r linux-x64 \
            --no-self-contained \
            -o "${{ matrix.publish_dir }}"

      - name: Package zip (${{ matrix.function_name }})
        run: |
          cd "${{ matrix.publish_dir }}"
          zip -r "../${{ matrix.function_name }}.zip" .
          cd - 1>/dev/null
        shell: bash

      - name: Update Lambda function code (${{ matrix.function_name }})
        run: |
          set -euo pipefail
          aws lambda update-function-code \
            --function-name "${{ matrix.function_name }}" \
            --zip-file "fileb://${{ matrix.zip_path }}"
          # Wait until the update is reflected as Active
          aws lambda wait function-updated --function-name "${{ matrix.function_name }}"
          aws lambda get-function-configuration --function-name "${{ matrix.function_name }}"


  frontend:
    name: Build and deploy frontend
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: "244706281753"
      S3_BUCKET: ${{ vars.FRONTEND_S3_BUCKET_DEV }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID_DEV }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: "KeyPay-Frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci
        working-directory: KeyPay-Frontend

      - name: Build React app
        run: npm run build
        working-directory: KeyPay-Frontend

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-oidc-keypay-dev
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3 (static assets and index.html)
        run: |
          set -euo pipefail

          if [ -z "${S3_BUCKET:-}" ]; then
            echo "S3_BUCKET is not set (expected in repository variables as FRONTEND_S3_BUCKET_DEV)"
            exit 1
          fi

          BUILD_DIR="KeyPay-Frontend/dist"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "Build directory not found at $BUILD_DIR"
            exit 1
          fi

          # Sync all files except index.html with long cache headers
          aws s3 sync "$BUILD_DIR" "s3://$S3_BUCKET" \
            --delete \
            --exclude "index.html" \
            --cache-control "public, max-age=31536000, immutable"

          # Upload index.html with no-cache to ensure users get latest shell
          aws s3 cp "$BUILD_DIR/index.html" "s3://$S3_BUCKET/index.html" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"

      - name: Invalidate CloudFront cache
        run: |
          set -euo pipefail

          if [ -z "${CLOUDFRONT_DISTRIBUTION_ID:-}" ]; then
            echo "CLOUDFRONT_DISTRIBUTION_ID is not set (expected in repository variables as CLOUDFRONT_DISTRIBUTION_ID_DEV)"
            exit 1
          fi

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "Created invalidation: $INVALIDATION_ID"

          # Wait up to ~5 minutes for completion (fast in most cases)
          for i in $(seq 1 30); do
            STATUS=$(aws cloudfront get-invalidation \
              --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
              --id "$INVALIDATION_ID" \
              --query 'Invalidation.Status' \
              --output text)
            echo "Invalidation status: $STATUS"
            if [ "$STATUS" = "Completed" ]; then
              echo "Invalidation completed."
              exit 0
            fi
            sleep 10
          done

          echo "Invalidation did not complete within time limit."
          exit 1
        shell: bash
